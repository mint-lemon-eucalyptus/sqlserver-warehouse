tinymce.PluginManager.add("sql", function (t) {
    t.addButton("sql", {text: "SQL", icon: !1, onclick: function () {
        if (!t.$sql) {
            var ang_scope = angular.element(document.getElementById('material-edit')).scope();
            t.$sql = {res: {mat_id: ang_scope.data.id}, lang: ang_scope.data.lang};
            console.log("not init");
            t.$sql.res.type = 'postgresql'
            $.post("/datasets/listWithUser", t.$sql.res, function (data) {
                if (data.err) {
                    alert('Datasets loading: Warning', JSON.stringify(data.err, null, 2));
                } else {
                    t.$sql.datasets = [];
                    data.response.map(function (ad) {
                        t.$sql.datasets.push({text: ad.name, value: ad.id});
                    });
                    t.$sql.res.dataset = data.response[0].id;
                    f();
                }
            });
        } else {
            f();
        }

        function f() {
            t.windowManager.open({title: "SQL plugin", body: [
                {type: 'listbox',
                    name: 'dataset',
                    label: 'dataset name',
                    'values': t.$sql.datasets,
                    onselect: function (v) {
                        t.$sql.res.dataset = this.value();
                        console.log('Value selected:', t.$sql.res);
                    }
                },
                {type: "checkbox", name: "executable", label: "Is executable", checked: true},
                {type: "textbox", name: "code", label: "",
                    multiline: !0, minWidth: t.getParam("code_dialog_width", 600), minHeight: t.getParam("code_dialog_height", Math.min(tinymce.DOM.getViewPort().h - 200, 500))
                }
            ],
                onsubmit: function (e) {
                    t.$sql.res.code = e.data.code.trim();
                    if (!t.$sql.res.code.length) {
                        return;
                    }
                    $.post("/examples/add", t.$sql.res, function (data) {
                        if (data.err) {
                            alert('Warning' + JSON.stringify(data, null, 2));
                            console.log(data);
                        } else {

                            t.insertContent(
                                "<br><div class='example' example-code>" +
                                    "<div class='example_code notranslate'>" + t.$sql.res.code.replace(/\n/g, '<br>') +
                                    "</div><br>" +
                                    ((e.data.executable) ? ('<a target="_blank" class="tryitbtn" href="/query_plugin/execute?type=sql&id=' + data.response[0].id + '">' + ((t.$sql.lang == 'en') ? 'Try it yourself' : 'Выполнить') + ' »</a>') : '') +
                                    "</div>")

                            angular.element(document.getElementById('material-edit')).scope().saveChanges(true)
                        }
                    });
                }
            })
        }

    }}),
        t.addMenuItem("sql", {text: "SQL plugin", context: "tools", onclick: function () {
            t.windowManager.open({title: "TinyMCE site", url: "http://www.tinymce.com", width: 800, height: 600, buttons: [
                {text: "Close", onclick: "close"}
            ]})
        }})
});